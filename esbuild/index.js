var te=Object.defineProperty;var Se=r=>te(r,"__esModule",{value:!0});var Le=(r,e)=>{for(var t in e)te(r,t,{get:e[t],enumerable:!0})};Se(exports);Le(exports,{BPlusTree:()=>b,distinct:()=>ge,eq:()=>Ne,every:()=>Pe,filter:()=>m,forEach:()=>Be,gt:()=>we,gte:()=>be,identity:()=>ve,includes:()=>Fe,lt:()=>ke,lte:()=>Ae,map:()=>Ge,mapReduce:()=>Ue,ne:()=>Ee,nin:()=>ze,print_node:()=>Ve,query:()=>He,queryFromArray:()=>Ce,range:()=>qe,reduce:()=>H,some:()=>De,sourceEach:()=>$,sourceEq:()=>D,sourceGt:()=>R,sourceGte:()=>S,sourceIn:()=>q,sourceLt:()=>L,sourceLte:()=>I,sourceRange:()=>O});function g(r,e,t){let o=-1,n=r.length;for(e=e==null&&typeof r[0]=="string"?"":e;o<n-1;){let i=o+n>>1;t(e,r[i])>=0?o=i:n=i}return n}function l(r){r.leaf?(r.key_num=r.keys.length,r.size=r.keys.length,r.isFull=r.size>r.t<<1,r.isEmpty=r.size<=0):(r.key_num=r.keys.length,r.size=r.children.length,r.isFull=r.size>r.t<<1,r.isEmpty=r.size<=0)}function N(r,e){r.max=e;let t=r;for(;t.parent;){let o=t.parent;if(o.children.indexOf(t.id)==o.children.length-1)o.max=e,t=o;else break}}function P(r,e){r.min=e;let t=r;for(;t.parent;){let o=t.parent,n=o.children.indexOf(t.id);if(n>0){o.keys[n-1]=e;break}else o.min=e,t=o}}function T(r){if(r.isEmpty)r.min=void 0,r.max=void 0;else{let e=r.tree.nodes;r.leaf?(P(r,r.keys[0]),N(r,r.keys[r.size-1])):(P(r,e.get(r.children[0]).min),N(r,e.get(r.children[r.size-1]).max))}}function oe(r,e){for(let t=0;t<e.length;t++){let o=e[t];r.children.push(o.id),r.keys.push(o.min),o.parent=r}r.keys.shift(),l(r),T(r)}function d(r,e,t){let o=-1,n=r.length;for(e=e==null&&typeof r[0]=="string"?"":e;o<n-1;){let i=o+n>>1;t(e,r[i])>0?o=i:n=i}return t(r[n],e)==0?n:-1}function Q(r,e){if(r.nodes.has(e.id))throw new Error("already here");e.tree=r,e.id=r.get_next_id(),r.nodes.set(e.id,e)}function ne(r,e){if(!r.nodes.has(e.id))throw new Error(`already removed ${e.id}`);e.tree=void 0,r.nodes.delete(e.id)}function _(r,e){let t=e,o=e=="left"?"right":"left";if(r[t]){let n=r[t];r[t]=n[t],n[t]&&(n[t][o]=r),n[o]=void 0,n[t]=void 0}}function ie(r){let e=r.tree.nodes.get(r.children.pop()),t=r.parent,o=t.children.indexOf(r.id);t.children[o]=e.id,e.parent=t,r.right&&_(r.right,"left"),r.left&&_(r.left,"right"),r.parent=void 0,r.delete(),t.commit()}function G(r,e){r.min=e;let t=r;for(;t.parent;){let o=t.parent,n=o.children.indexOf(t.id);if(n>0){o.keys[n-1]=e;break}else o.min=e,t=o}}function U(r,e){r.max=e;let t=r;for(;t.parent;){let o=t.parent;if(o.children.indexOf(t.id)==o.key_num)o.max=e,t=o;else break}}var f=class{static createLeaf(e){let t=new f;return t.leaf=!0,t.pointers=[],Q(e,t),t}static createNode(e){let t=new f;return t.children=[],t.leaf=!1,Q(e,t),t}static createRootFrom(e,...t){let o=f.createNode(e);return oe(o,t),o}static serialize(e){let{id:t,leaf:o,t:n,_parent:i,_left:s,_right:u,isEmpty:a,isFull:p,max:J,min:M,size:k,keys:Y,key_num:Oe,pointers:$e,children:Re}=e;return{id:t,leaf:o,t:n,_parent:i,_left:s,_right:u,isEmpty:a,isFull:p,max:J,min:M,size:k,keys:e.tree.keySerializer(Y),key_num:Oe,pointers:$e,children:Re}}static deserialize(e){let t=new f;return t.id=e.id,t.leaf=e.leaf,t._parent=e._parent,t._left=e._left,t._right=e._right,t.isEmpty=e.isEmpty,t.isFull=e.isFull,t.max=e.max,t.min=e.min,t.size=e.size,t.keys=t.tree.keyDeserializer(e.keys),t.key_num=e.key_num,t.pointers=e.pointers,t.children=e.children,t}get t(){return this.tree?.t??32}constructor(){this.keys=[],this.key_num=0,this.size=0,this.isFull=!1,this.isEmpty=!0,this.min=void 0,this.max=void 0}delete(){this.tree?.root!=this.id&&ne(this.tree,this)}insert(e){let[t,o]=e,n=g(this.keys,t,this.tree.comparator);this.keys.splice(n,0,t),this.pointers.splice(n,0,o),l(this),n==0&&G(this,t),n==this.size-1&&U(this,t)}remove(e){let t=d(this.keys,e,this.tree.comparator),o=[e,this.pointers.splice(t,1)[0]];return this.keys.splice(t,1),l(this),t==0&&P(this,this.keys[0]),t==this.keys.length&&N(this,this.keys[t-1]),o}commit(){this.key_num==0&&this.size==1&&this.parent&&!this.leaf&&(ie(this),this.parent?.size>0&&this.parent.commit())}get errors(){return Ie(this)}toJSON(){return this.leaf?{t:this.t,isEmpty:this.isEmpty,size:this.size,children:[],id:this.id,leaf:this.leaf,keys:this.tree.keySerializer(this.keys),key_num:this.key_num,min:this.min,max:this.max,pointers:this.pointers,_left:this._left,_right:this._right,_parent:this._parent,isFull:this.isFull,errors:this.errors}:{id:this.id,t:this.t,isEmpty:this.isEmpty,size:this.size,leaf:this.leaf,keys:this.tree.keySerializer(this.keys),key_num:this.key_num,min:this.min,max:this.max,_left:this._left,_right:this._right,children:this.children,pointers:void 0,_parent:this._parent,isFull:this.isFull,errors:this.errors}}get parent(){return this.tree?.nodes.get(this._parent)??void 0}set parent(e){this._parent=e?.id??void 0}get left(){return this.tree?.nodes.get(this._left)??void 0}set left(e){this._left=e?.id??void 0}get right(){return this.tree?.nodes.get(this._right)??void 0}set right(e){this._right=e?.id??void 0}};function Ie(r){let e=[];return r.isEmpty||(r.leaf||(r.children.length!=r.keys.length+1&&e.push(`!children ${r.leaf?"L":"N"}${r.id} ${r.children.length} ${r.keys.length}`),r.keys.length!=r.key_num&&e.push(`!keys ${r.id}`)),r.size!=(r.leaf?r.key_num:r.children.length)&&e.push(`!size ${r.id}`)),e}function A(r,e){let t=r.children.indexOf(e.id);r.children.splice(t,1),t==0?r.keys.shift():r.keys.splice(t-1,1),e.parent=void 0,e.right&&_(e.right,"left"),e.left&&_(e.left,"right"),l(e),l(r);let o=r.tree.nodes;if(t==0){let n=o.get(r.children[0])?.min;G(r,n)}if(t==r.size){let n=o.get(r.children[r.key_num])?.max;U(r,n)}return e}function F(r,e,t){if(r.leaf)r.keys.unshift(...e.keys.splice(-t)),r.pointers.unshift(...e.pointers.splice(-t)),l(r),T(r),l(e),T(e);else{r.size>0&&r.keys.unshift(r.min),r.keys.unshift(...e.keys.splice(-t)),e.size!=t&&r.keys.shift();let o=r.tree.nodes;r.children.unshift(...e.children.splice(-t).map(n=>(o.get(n).parent=r,n))),l(r),T(r),l(e),T(e)}}function W(r,e,t){if(r.leaf)r.keys.push(...e.keys.splice(0,t)),r.pointers.push(...e.pointers.splice(0,t)),l(r),T(r),l(e),T(e);else{r.size>0&&r.keys.push(r.min),r.keys.push(...e.keys.splice(0,t-1)),e.size!=t&&e.keys.shift();let o=r.tree.nodes;r.children.push(...e.children.splice(0,t).map(n=>(o.get(n).parent=r,n))),l(r),T(r),l(e),T(e)}}function E(r){let e=r;return e.left?.size>e.t-1&&e.left?.size>1?e.left?.size-e.t-1:0}function se(r){let e=r;return e.right?.size>e.t-1&&e.right?.size>1?e.right?.size-e.t-1:0}function y(r,e){if(e)if(e.key_num<r.t-1||e.isEmpty){let t=e.right,o=e.left,n=E(e),i=se(e);if(n>0||i>0)n>i?(F(e,o,n),e.commit()):(W(e,t,i),e.commit());else{if(e.isEmpty){o?_(o,"right"):t&&_(t,"left");let s=e.parent;s&&A(s,e),e.commit(),s&&(y(r,s),o?s!=o.parent&&y(r,o.parent):t&&s!=t.parent&&y(r,t.parent))}else if(o){W(o,e,e.size);let s=e.parent;s&&A(s,e),e.commit(),y(r,s),s!=o.parent?y(r,o.parent):o.commit()}else if(t){F(t,e,e.size);let s=e.parent;s&&A(s,e),e.commit(),y(r,s),s!=t.parent&&y(r,t.parent)}else if(e.isEmpty){let s=e.parent;e.right&&_(e.right,"left"),e.left&&_(e.left,"right"),s&&A(s,e),y(r,s),e.commit()}e.delete()}}else e.commit()}function z(r){let e=r.nodes,t=e.get(r.root);if(t.size==1&&!t.leaf){let o=e.get(r.root),n=e.get(t.children.pop());r.root=n.id,n.parent=void 0,o.delete()}}function X(r,e,t,o=!1){let n=[];if(o)for(;d(e.keys,t,r.comparator)!=-1;)n.push(e.remove(t));else n.push(e.remove(t));return y(r,e),z(r),n}function V(r,e,t){let o=-1,n=r.length;for(e=e==null&&typeof r[0]=="string"?"":e;o<n-1;){let i=o+n>>1;t(e,r[i])>0?o=i:n=i}return n}function v(r,e){let t=r.nodes,o=t.get(r.root),n=r.comparator;for(;o.leaf!=!0;){let i=V(o.keys,e,n);if(o=t.get(o.children[i]),!r.unique){if(n(e,o.min)<=0&&n(e,o.left?.max)<=0)for(;n(e,o.left?.max)<=0&&o.left;)o=o.left;else if(n(o.max,e)<0)for(;n(o.max,e)<0&&o.right;){o=o.right;if(n(e,o.right?.min)>=0)break}}}return o}function B(r,e,t){let o=-1,n=r.length;for(e=e==null&&typeof r[0]=="string"?"":e;o<n-1;){let i=o+n>>1;t(e,r[i])<=0?n=i:o=i}return t(r[n],e)==0?n:-1}function Z(r,e,t=!1){let o=[],n=v(r,e);if(B(n.keys,e,r.comparator)>-1)if(t)do o.push(...X(r,n,e,t)),n=v(r,e);while(B(n.keys,e,r.comparator)!=-1);else o.push(...X(r,n,e,t));return o}function ue(r,e){let t=[],o=new Set;for(let n of e){let i=r.nodes.get(n.node),{key:s,pos:u}=n;t.push([s,i.pointers.splice(u,1,void 0)[0]]),i.keys.splice(u,1,void 0),o.add(n.node)}for(let n of o){let i=r.nodes.get(n),s=[],u=[];for(let a=0;a<i.size;a++)i.keys[a]!==void 0&&(s.push(i.keys[a]),u.push(i.pointers[a]));i.keys=s,i.pointers=u,l(i),i.min!=i.keys[0]&&P(i,i.keys[0]),i.max!=i.keys[i.keys.length-1]&&N(i,i.keys[i.keys.length-1])}for(let n of o){let i=r.nodes.get(n);i&&(y(r,i),z(r))}return t}function ae(r,e,t){let o=[];for(let n of r.equalsNulls(e)(r))t(n.value)&&o.push(n);return ue(r,o)}function pe(r,e,t){let o=r.children.indexOf(t.id);r.children.splice(o+1,0,e.id),r.keys.splice(o,0,e.min),e.parent=r,l(r),T(r)}function le(r,e,t){let o=t,n=t=="left"?"right":"left";e[o]=r[o],r[o]&&(e[o][n]=e),r[o]=e,e[n]=r}function j(r,e){let t=e.leaf?f.createLeaf(r):f.createNode(r);le(e,t,"right");let o=E(t);if(F(t,e,o),e.id==r.root)r.root=f.createRootFrom(r,e,t).id;else{let n=e.parent;pe(n,t,e),n.isFull&&j(r,n)}t.commit()}function me(r,e,t){let o=v(r,e);return d(o.keys,e,r.comparator)>-1&&r.unique?!1:(o.insert([e,t]),o.isFull&&j(r,o),!0)}function ee(r,e){let t=0,o=V(e.keys,r,e.tree.comparator),n=e.tree.nodes,i=o;if(e.leaf)for(;e.keys[i]==r;)t++,i++;else{let s=e.size;for(;i<s;)t+=ee(r,n.get(e.children[i])),i++}return t}function re(r){let e=0,o=0;if(r.leaf)return r.key_num;{let n=r.tree.nodes,i=r.size;for(;o<i;)e+=re(n.get(r.children[o])),o++;return e}}function h(r,e){let t=r.nodes,o=t.get(r.root);for(;o.leaf!=!0;){let n=g(o.keys,e,r.comparator);o=t.get(o.children[n])}return o}function fe(r,e){let t=r.pointers[e];return{node:r.id,pos:e,key:r.keys[e],value:t,done:t===void 0}}function K(r,e,t){let o=r.nodes.get(e);for(;o;){let n=o.pointers.length;if(t>=n)o=o.right,t-=n;else if(t<0)o=o.left,o&&(t+=o.pointers.length);else return fe(o,t)}return{node:void 0,pos:void 0,key:void 0,value:void 0,done:!0}}function C(r,e,t=!0){let o,n;t?(o=h(r,e),n=d(o.keys,e,r.comparator)):(o=h(r,e),n=d(o.keys,e,r.comparator));let i=o.pointers[n];return{node:o.id,pos:n,key:e,value:i,done:i===void 0}}function Te(r,e,t){let{skip:o=0,forward:n=!0,take:i=-1}=t??{},{take:s=-1}=t??{},u=[],a=C(r,e,n);if(a.pos>=0){let p;if(o==0?p=a:p=K(r,a.node,a.pos+(n?o:-o)),!p.done&&p.key==e)if(s==-1&&i!=-1)u.push(p.value);else for(;(p||s==0)&&(p.key==e&&p.pos>=0);)u.push(p.value),s-=1,p=K(r,p.node,p.pos+(n?1:-1))}return u}function de(r,e){let{take:t=-1}=e??{},{skip:o=0,forward:n=!0}=e??{},i=[],s=e.forward?r.min:r.max,u=C(r,s,n);if(u.pos>=0){let a;if(o==0?a=u:a=K(r,u.node,u.pos+(n?o:-o)),a)if(t==-1)i.push(a.value);else for(;a&&t!=0&&a.pos>=0;)i.push(a.value),t-=1,a=K(r,a.node,a.pos+(n?1:-1))}return i}function c(r,e,t){return K(r,e,t+1)}function q(r){return function*(e){let t,o=0;do do{let n=r[o];if(t?t=c(e,t.node,t.pos):t=C(e,n,!0),!t.done&&t.key!=n)o+=1,o<r.length&&(t=void 0);else if(!t.done){yield t;break}}while(o<r.length);while(!t.done)}}function D(r){return function*(e){let t=C(e,r,!0);for(;!t.done&&t.key==r;){yield t;t=c(e,t.node,t.pos)}}}function x(r,e,t,o=!0){let n,i;return o?(n=v(r,e),t?i=V(n.keys,e,r.comparator):i=g(n.keys,e,r.comparator)):(n=h(r,e),t?i=g(n.keys,e,r.comparator)-1:i=V(n.keys,e,r.comparator)-1),K(r,n.id,i)}function O(r,e,t=!0,o=!0){return function*(n){let i=x(n,e,o,!1),s=x(n,r,t,!0);for(;!s.done;){if(yield s,s.node==i.node&&s.pos==i.pos)return;s=c(n,s.node,s.pos)}}}function w(r,e,t){return K(r,e,t-1)}function $(r=!0){return function*(e){let t=r?c:w,o=e.cursor(e.min);for(;!o.done;)yield o,o=t(e,o.node,o.pos)}}function R(r){return function*(e){let t=x(e,r,!1,!0);for(;!t.done;)yield t,t=c(e,t.node,t.pos)}}function S(r){return function*(e){let t=x(e,r,!0,!0);for(;!t.done;)yield t,t=c(e,t.node,t.pos)}}function L(r){return function*(e){let t=x(e,r,!1,!1);for(;!t.done;)yield t,t=w(e,t.node,t.pos)}}function I(r){return function*(e){let t=x(e,r,!0,!1);for(;!t.done;)yield t,t=w(e,t.node,t.pos)}}function ce(r,e,t=!0){let o,n;t?(o=h(r,e),e!=null?n=B(o.keys,e,r.comparator):n=d(o.keys,e,r.comparator)):(o=h(r,e),e!=null?n=B(o.keys,e,r.comparator):n=d(o.keys,e,r.comparator));let i=o.pointers[n];return{node:o.id,pos:n,key:e,value:i,done:i===void 0}}function ye(r){return function*(e){let t=ce(e,r,!0);for(;!t.done&&t.key==r;){yield t;t=c(e,t.node,t.pos)}}}function Ke(r,e,t){let o=-1,n=r.length;for(e=e==null&&typeof r[0]=="string"?"":e;o<n-1;){let i=o+n>>1;t(e,r[i])>=0?o=i:n=i}return t(r[n],e)==0?n:-1}function _e(r,e){return r!=null&&e!=null?r<e?-1:r>e?1:0:r!=null?1:e!=null?-1:0}var b=class{constructor(e,t,o,n,i,s){this.nodes=new Map;this.next_node_id=0;this.t=e??32,this.unique=t??!1,this.root=f.createLeaf(this).id,this.comparator=o??_e,this.defaultEmpty=n??Number.NEGATIVE_INFINITY,this.keySerializer=i??(u=>u),this.keyDeserializer=s??(u=>u)}get_next_id(){return this.next_node_id++}includes(e){return q(e)}equals(e){return D(e)}equalsNulls(e){return ye(e)}range(e,t,o=!0,n=!0){return O(e,t,o,n)}each(e=!0){return $(e)}gt(e){return R(e)}gte(e){return S(e)}lt(e){return L(e)}lte(e){return I(e)}static serialize(e){let{t,root:o,unique:n,nodes:i,next_node_id:s}=e;return{t,next_node_id:s,root:o,unique:n,nodes:[...i.values()].map(u=>f.serialize(u))}}static createFrom(e){let t=new b;return b.deserialize(t,e),t}static deserialize(e,t){let{t:o,next_node_id:n,root:i,unique:s,nodes:u}=t;if(o)e.nodes.clear(),e.t=o,e.next_node_id=n,e.root=i,e.unique=s,u.forEach(a=>{let p=f.deserialize(a);p.tree=e,e.nodes.set(a.id,p)});else for(let[a,p]of Object.entries(t))e.insert(a,p)}find(e,{skip:t=0,take:o=-1,forward:n=!0}={}){return Te(this,e,{skip:t,take:o,forward:n})}list({skip:e=0,take:t=-1,forward:o=!0}={}){return de(this,{skip:e,take:t,forward:o})}findFirst(e){let t=v(this,e),o=d(t.keys,e,this.comparator);return t.pointers[o]}findLast(e){let t=h(this,e),o=Ke(t.keys,e,this.comparator);return t.pointers[o]}cursor(e){let t=h(this,e),o=V(t.keys,e,this.comparator),n=t.pointers[o];return{node:t.id,pos:o,key:e,value:n,done:n===void 0}}reset(){this.next_node_id=0,this.nodes.clear(),this.root=f.createLeaf(this).id}get min(){return this.nodes.get(this.root).min}get max(){return this.nodes.get(this.root).max}get size(){return re(this.nodes.get(this.root))}node(e){return this.nodes.get(e)}count(e){return e==null&&(e=null),ee(e,this.nodes.get(this.root))}insert(e,t){return e==null&&(e=this.defaultEmpty),me(this,e,t)}removeSpecific(e,t){return e==null&&(e=null),ae(this,e,t)}remove(e){return e==null&&(e=null),Z(this,e,!1)}removeMany(e){return e==null&&(e=null),Z(this,e,!0)}toJSON(){return{t:this.t,unique:this.unique,root:this.nodes.get(this.root).toJSON()}}};function he(r,e,t){let o=[];return xe(r,"",o,e,t),o}function xe(r,e,t,o,n){let i=e.length===0,s=n(r)||[],u="";i||(u=s&&s.length!==0?"\u252C ":"\u2500 ");let a=o(r,`${e}${u}`);typeof a=="string"&&t.push(`${e}${u}${a}`);let p=e;if(!i){let k=e.slice(-2)==="\u2514\u2500";p=e.slice(0,-2)+(k?"  ":"\u2502 ")}let J=p+"\u251C\u2500",M=p+"\u2514\u2500";s.forEach((k,Y)=>{xe(k,s.length-1===Y?M:J,t,o,n)})}function Ve(r,e){e||(e=r.node(r.root));let t=r.nodes;return he(e?.toJSON(),o=>`${o._parent?"N":""}${o._parent??""}${o._parent?"<-":""}${o.isFull?"!":""}${o.leaf?"L":"N"}${o.id} <${JSON.stringify(o.min)??""}:${JSON.stringify(o.max)??""}> ${JSON.stringify(o.keys)} L:${o.leaf?"L":"N"}${o._left??"-"} R:${o.leaf?"L":"N"}${o._right??"-"} ${o.leaf?JSON.stringify(o.pointers):""} ${o.errors.length==0?"":"[error]: "+o.errors.join(";")}`,o=>o.children.map(n=>t.get(n).toJSON()))}function He(...r){return Ce(r)}function ve(r){return r}function Ce(r){return r.length===0?ve:r.length===1?r[0]:function(e){let t=e;return r.forEach(o=>{t=o(t)}),t}}function H(r,e){return async function*(t){let o=e;for await(let n of t)o=await r(o,n.value);yield o}}function ge(){return H((r,e)=>(r.add(e),r),new Set)}function m(r){return async function*(e){for await(let t of e)await r([t.key,t.value])&&(yield t)}}function Ne(r){return m(([e])=>e==r)}function Pe(r){return async function*(e){for await(let t of e)if(!await r([t.key,t.value])){yield!1;return}yield!0}}function Be(r){return async function*(e){for await(let t of e)await r([t.key,t.value]),yield t}}function we(r){return m(([e])=>e>r)}function be(r){return m(([e])=>e>=r)}function ke(r){return m(([e])=>e<r)}function Ae(r){return m(([e])=>e<=r)}function Fe(r){return m(([e])=>r.includes(e))}function Ge(r){return async function*(e){for await(let t of e){let o=await r([t.key,t.value]);yield{...t,value:o}}}}function Ue(r,e,t){return async function*(o){let n=new Map;for(let i of o){let s=await r([i.key,i.value]),u=await e([i.key,s]);n.set(i.key,u)}yield await t?.(n)??n}}function Ee(r){return m(([e])=>e!=r)}function ze(r){return m(([e])=>!r.includes(e))}function qe(r,e,t=!0,o=!0){return m(([n])=>(n>r||t&&n==r)&&(n<e||o&&n==e))}function De(r){return async function*(e){for await(let t of e)if(r([t.key,t.value])){yield!0;return}yield!1}}0&&(module.exports={BPlusTree,distinct,eq,every,filter,forEach,gt,gte,identity,includes,lt,lte,map,mapReduce,ne,nin,print_node,query,queryFromArray,range,reduce,some,sourceEach,sourceEq,sourceGt,sourceGte,sourceIn,sourceLt,sourceLte,sourceRange});
//# sourceMappingURL=index.js.map
