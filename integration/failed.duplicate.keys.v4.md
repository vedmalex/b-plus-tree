# –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –ø–∞–¥–∞—é—â–µ–≥–æ —Ç–µ—Å—Ç–∞: "should remove duplicates one by one sequentially using remove_in_transaction" v4

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
–¢–µ—Å—Ç –ø–∞–¥–∞–µ—Ç –Ω–∞ —Å—Ç—Ä–æ–∫–µ 941:
```
expect(tree.size).toBe(2);
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** `2` (–¥–æ–ª–∂–Ω–æ –æ—Å—Ç–∞—Ç—å—Å—è 2 —ç–ª–µ–º–µ–Ω—Ç–∞: 1 –∫–ª—é—á 10 + 1 –∫–ª—é—á 20)
**–ü–æ–ª—É—á–∞–µ—Ç—Å—è:** `1` (–æ—Å—Ç–∞–ª—Å—è —Ç–æ–ª—å–∫–æ 1 —ç–ª–µ–º–µ–Ω—Ç)

## –ê–Ω–∞–ª–∏–∑ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π

### –ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –î–∞–Ω–Ω—ã–µ: `[[10, 'A1'], [20, 'B1'], [10, 'A2'], [30, 'C1'], [10, 'A3'], [20, 'B2']]`
- `tree.size = 6`

### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∏–π:
1. `remove_in_transaction(10)` ‚Üí `tree.size = 5` ‚úÖ
2. `remove_in_transaction(20)` ‚Üí `tree.size = 4` ‚úÖ
3. `remove_in_transaction(10)` ‚Üí `tree.size = 3` ‚úÖ
4. `remove_in_transaction(30)` ‚Üí `tree.size = 2` ‚ùå **–ü–†–û–ë–õ–ï–ú–ê –ó–î–ï–°–¨!**

### –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —à–∞–≥–µ 4
–ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª—é—á–∞ 30, –æ–∂–∏–¥–∞–µ—Ç—Å—è `tree.size = 2`, –Ω–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è `tree.size = 1`.

–ò–∑ –ª–æ–≥–æ–≤ –≤–∏–¥–Ω–æ:
```
[TEST DEBUG] Manual search for key 10: count=0
[TEST DEBUG] Manual search for key 20: count=1
[size] Final result: 1 from root 24
```

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –£–∑–ª—ã —Å –∫–ª—é—á–æ–º 10 —Å—Ç–∞–ª–∏ orphaned (–Ω–µ–¥–æ—Å—Ç–∏–∂–∏–º—ã–º–∏ –æ—Ç –∫–æ—Ä–Ω—è) –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª—é—á–∞ 30.

## –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–µ—Ä–µ–≤–∞ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è 30

### –ò–∑ –ª–æ–≥–æ–≤:
```
[TEST DEBUG] Final root 24: keys=[20], children=[3,23]
[TEST DEBUG] All existing nodes:
[TEST DEBUG] Node 2: leaf=true, keys=[10], children=[none]  ‚Üê ORPHANED!
[TEST DEBUG] Node 11: leaf=true, keys=[10], children=[none] ‚Üê ORPHANED!
```

### –ü—Ä–æ–±–ª–µ–º–∞:
1. **–£–∑–ª—ã 2 –∏ 11** —Å–æ–¥–µ—Ä–∂–∞—Ç –∫–ª—é—á 10, –Ω–æ –æ–Ω–∏ orphaned
2. **size()** –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç orphaned nodes:
   ```
   [size] Skipping alternative leaf 2 because it's not reachable from current root (orphaned node)
   [size] Skipping alternative leaf 11 because it's not reachable from current root (orphaned node)
   ```
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** `tree.size = 1` –≤–º–µ—Å—Ç–æ –æ–∂–∏–¥–∞–µ–º—ã—Ö `2`

## –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

### –ü—Ä–æ–±–ª–µ–º–∞ –≤ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö underflow/merge:
–í–æ –≤—Ä–µ–º—è —É–¥–∞–ª–µ–Ω–∏—è –∫–ª—é—á–∞ 30 –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç —Å–ª–æ–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ underflow –∏ merge, –∫–æ—Ç–æ—Ä—ã–µ:
1. –°–æ–∑–¥–∞—é—Ç –Ω–æ–≤—ã–µ working nodes
2. –û–±–Ω–æ–≤–ª—è—é—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–µ—Ä–µ–≤–∞
3. **–ù–û –ù–ï –ü–†–ê–í–ò–õ–¨–ù–û –ü–ï–†–ï–ù–û–°–Ø–¢ –í–°–ï –î–ê–ù–ù–´–ï** –≤ –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É

### –ò–∑ –ª–æ–≥–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è 30:
```
[remove_in_transaction] Found internal node 3 with empty keys but 1 children - needs special handling
[remove_in_transaction] Processing empty internal node 3, keys=[], children=[2]
[remove_in_transaction] Removing empty internal node 3 from parent 29 at index 0
[remove_in_transaction] Replacing internal node 3 (keys=[]) with its single child 2
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –£–∑–µ–ª 2 (—Å –∫–ª—é—á–æ–º 10) –¥–æ–ª–∂–µ–Ω –±—ã–ª –±—ã—Ç—å –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –Ω–æ –æ—Å—Ç–∞–ª—Å—è orphaned.

## –†–µ—à–µ–Ω–∏–µ

–ù—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–ø–µ—Ä–∞—Ü–∏–π underflow/merge, —á—Ç–æ–±—ã:
1. **–ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ** –ø—Ä–∏ —Ä–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏–∏ –¥–µ—Ä–µ–≤–∞
2. **–û–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å reachability** –≤—Å–µ—Ö —É–∑–ª–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–Ω—è
3. **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ orphaned nodes** —Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

### –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
1. **–í `remove_in_transaction`**: —É–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏–∫—É final cleanup –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è orphaned nodes —Å –¥–∞–Ω–Ω—ã–º–∏
2. **–í –æ–ø–µ—Ä–∞—Ü–∏—è—Ö merge**: –æ–±–µ—Å–ø–µ—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–Ω–æ—Å –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
3. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏** –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–π underflow/merge

## –¢—Ä–µ—Ç—å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–ü–†–û–ë–õ–ï–ú–ê –ù–ê–ô–î–ï–ù–ê!)
–î–æ–±–∞–≤–∏–ª–∏ —Å–∏—Å—Ç–µ–º—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è orphaned nodes, –Ω–æ –æ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:

```
[remove_in_transaction] CRITICAL: Found orphaned working leaf 8 with valid data: keys=[10], values=[A3]
[remove_in_transaction] CRITICAL: Merging orphaned data from node 8 into reachable leaf 2
[remove_in_transaction] CRITICAL: Successfully merged orphaned data, target leaf 2 now has 2 keys
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Ö–æ–¥–∏—Ç orphaned nodes —Å –∫–ª—é—á–æ–º, –∫–æ—Ç–æ—Ä—ã–π –º—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —É–¥–∞–ª–∏–ª–∏, –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –µ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ –≤ –¥–µ—Ä–µ–≤–æ!

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –õ–æ–≥–∏–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç, —á—Ç–æ orphaned node –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã, –∞ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.

## –†–µ—à–µ–Ω–∏–µ
–ù—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è orphaned nodes:
1. **–ù–ï –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å** –¥–∞–Ω–Ω—ã–µ —Å –∫–ª—é—á–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —É–¥–∞–ª–∏–ª–∏
2. –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∫–ª—é—á–∞—Ö –≤ —Å–∏—Å—Ç–µ–º—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
3. –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å orphaned nodes –ø–æ —É–¥–∞–ª–µ–Ω–Ω—ã–º –∫–ª—é—á–∞–º

## –ß–µ—Ç–≤–µ—Ä—Ç–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–ß–ê–°–¢–ò–ß–ù–û –£–°–ü–ï–®–ù–û–ï!)
–û—Ç–∫–ª—é—á–∏–ª–∏ —Å–∏—Å—Ç–µ–º—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è orphaned nodes:

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –±–æ–ª—å—à–µ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç —É–¥–∞–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ
- ‚ùå –ù–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è orphaned –∏ —Ç–µ—Ä—è—é—Ç—Å—è

## –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π –ø—Ä–æ–±–ª–µ–º—ã

### –ò–∑ –ª–æ–≥–æ–≤ –≤–∏–¥–Ω–æ:
```
[size] Skipping alternative leaf 2 because it's not reachable from current root (orphaned node)
[size] Skipping alternative leaf 11 because it's not reachable from current root (orphaned node)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –£–∑–ª—ã —Å –∫–ª—é—á–æ–º 10 (–ª–∏—Å—Ç—å—è 2 –∏ 11) —Å—Ç–∞–ª–∏ orphaned –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–π underflow/merge.

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –õ–æ–≥–∏–∫–∞ underflow/merge –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–µ—Ä–µ–≤–∞, —Å–æ–∑–¥–∞–≤–∞—è orphaned nodes —Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

**–†–µ—à–µ–Ω–∏–µ:** –ù—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É underflow/merge, —á—Ç–æ–±—ã –æ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–ª–∞ —Å–≤—è–∑–Ω–æ—Å—Ç—å –¥–µ—Ä–µ–≤–∞.

## –ü—è—Ç–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–ó–ù–ê–ß–ò–¢–ï–õ–¨–ù–´–ô –ü–†–û–ì–†–ï–°–°!)
–î–æ–±–∞–≤–∏–ª–∏ –ø—Ä–æ—Å—Ç—É—é —Å–∏—Å—Ç–µ–º—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è orphaned nodes:

```typescript
// SIMPLE FIX: Check for orphaned nodes with valid data and reconnect them
// Skip nodes that contain the removed key
const containsRemovedKey = node.keys.some(nodeKey => this.comparator(nodeKey, key) === 0);
if (!containsRemovedKey) {
  orphanedLeaves.push({ nodeId, node });
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –¢–µ—Å—Ç –ø—Ä–æ–¥–≤–∏–Ω—É–ª—Å—è —Å —Å—Ç—Ä–æ–∫–∏ 941 –Ω–∞ —Å—Ç—Ä–æ–∫—É 945 (–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å!)
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∑–∞–≤–∏—Å–∞–Ω–∏–π
- ‚ùå –ù–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞: —Å—Ç—Ä–æ–∫–∞ 945 –æ–∂–∏–¥–∞–µ—Ç `tree.count(10) = 0`, –ø–æ–ª—É—á–∞–µ—Ç `tree.count(10) = 1`

## –ê–Ω–∞–ª–∏–∑ –Ω–æ–≤–æ–π –ø—Ä–æ–±–ª–µ–º—ã

### –ò–∑ –ª–æ–≥–æ–≤ –≤–∏–¥–Ω–æ:
```
[remove_in_transaction] SIMPLE FIX: Found orphaned leaf 2 with valid data: keys=[10]
[remove_in_transaction] SIMPLE FIX: Found orphaned leaf 11 with valid data: keys=[10]
[remove_in_transaction] SIMPLE FIX: Reconnecting 2 orphaned leaves to root
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Ö–æ–¥–∏—Ç orphaned nodes —Å –∫–ª—é—á–æ–º 10 –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏—Ö, –Ω–æ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ü–û–°–õ–ï —É–¥–∞–ª–µ–Ω–∏—è –∫–ª—é—á–∞ 10.

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –õ–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ `containsRemovedKey` —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - –æ–Ω–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–ª—é—á–∏ –≤ orphaned nodes, –Ω–æ —ç—Ç–∏ nodes –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã.

## –†–µ—à–µ–Ω–∏–µ
–ù—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –≤ –ø—Ä–æ—Å—Ç–æ–π —Å–∏—Å—Ç–µ–º–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:
1. **–ü—Ä–æ–≤–µ—Ä—è—Ç—å timestamp** –∏–ª–∏ **transaction context** orphaned nodes
2. **–ù–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å nodes**, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã –î–û —Ç–µ–∫—É—â–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
3. **–¢–æ–ª—å–∫–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å nodes** —Å –¥–∞–Ω–Ω—ã–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï —Å–≤—è–∑–∞–Ω—ã —Å —Ç–µ–∫—É—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π —É–¥–∞–ª–µ–Ω–∏—è

## –®–µ—Å—Ç–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–û–¢–õ–ò–ß–ù–´–ô –ü–†–û–ì–†–ï–°–°!)
–£–ª—É—á—à–∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –≤ —Å–∏—Å—Ç–µ–º–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è orphaned nodes:

```typescript
// ENHANCED: Skip nodes that contain the removed key OR were modified in this transaction
const containsRemovedKey = node.keys.some(nodeKey => this.comparator(nodeKey, key) === 0);
const wasModifiedInTransaction = txCtx.workingNodes.has(nodeId) || txCtx.deletedNodes.has(nodeId);

if (!containsRemovedKey && !wasModifiedInTransaction) {
  orphanedLeaves.push({ nodeId, node });
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç orphaned nodes —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º –∫–ª—é—á–æ–º
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç nodes, –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ –¢–µ—Å—Ç –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–æ–∫–µ 945 (—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!)
- ‚ùå –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: `tree.count(10) = 1` –≤–º–µ—Å—Ç–æ `tree.count(10) = 0`

## –ê–Ω–∞–ª–∏–∑ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã

### –ò–∑ –ª–æ–≥–æ–≤ –≤–∏–¥–Ω–æ:
```
[remove_in_transaction] SIMPLE FIX: Skipping orphaned leaf 2 because it contains removed key 10: keys=[10]
[remove_in_transaction] SIMPLE FIX: Skipping orphaned leaf 18 because it was modified in this transaction: keys=[20]
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ì–¥–µ-—Ç–æ –≤ –¥–µ—Ä–µ–≤–µ –≤—Å–µ –µ—â–µ –æ—Å—Ç–∞–µ—Ç—Å—è —É–∑–µ–ª —Å –∫–ª—é—á–æ–º 10, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –±—ã–ª –Ω–∞–π–¥–µ–Ω –∏ —É–¥–∞–ª–µ–Ω.

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. **–£–∑–µ–ª 11** —Å –∫–ª—é—á–æ–º 10 –æ—Å—Ç–∞–µ—Ç—Å—è –≤ –¥–µ—Ä–µ–≤–µ –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
2. **Alternative search** –≤ `count()` –Ω–∞—Ö–æ–¥–∏—Ç —ç—Ç–æ—Ç —É–∑–µ–ª
3. **–õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è** –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ—Ç –≤—Å–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –∫–ª—é—á–∞

## –†–µ—à–µ–Ω–∏–µ
–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è:
1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —É–∑–ª—ã** –≤ –¥–µ—Ä–µ–≤–µ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞
2. **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–∏—Ç—å** –ª—é–±—ã–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —ç–∫–∑–µ–º–ø–ª—è—Ä—ã
3. **–û–±–µ—Å–ø–µ—á–∏—Ç—å –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É** –∫–ª—é—á–∞ –∏–∑ –¥–µ—Ä–µ–≤–∞

## –°–µ–¥—å–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–°–ò–°–¢–ï–ú–ê –†–ê–ë–û–¢–ê–ï–¢, –ù–û –°–õ–ò–®–ö–û–ú –ê–ì–†–ï–°–°–ò–í–ù–ê!)
–î–æ–±–∞–≤–∏–ª–∏ —Ñ–∏–Ω–∞–ª—å–Ω—É—é –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—É—é –æ—á–∏—Å—Ç–∫—É:

```typescript
// FINAL VERIFICATION: Ensure the removed key is completely eliminated from the tree
// Force remove any remaining instances
if (remainingInstances.length > 0) {
  // Remove all instances of the key from nodes
  for (const { nodeId, indices } of remainingInstances) {
    // Remove all instances and delete empty nodes
  }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç –∏ —É–¥–∞–ª—è–µ—Ç –í–°–ï –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –∫–ª—é—á–∞
- ‚úÖ –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ
- ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –°–∏—Å—Ç–µ–º–∞ —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞ - —É–¥–∞–ª—è–µ—Ç –í–°–ï —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ
- ‚ùå –¢–µ—Å—Ç —Ç–µ–ø–µ—Ä—å –ø–∞–¥–∞–µ—Ç –Ω–∞ —Å—Ç—Ä–æ–∫–µ 891 –≤–º–µ—Å—Ç–æ 945 (—Ä–µ–≥—Ä–µ—Å—Å–∏—è!)

## –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –ò–∑ –ª–æ–≥–æ–≤ –≤–∏–¥–Ω–æ:
```
[remove_in_transaction] FINAL CLEANUP: Removed 2 instances from node 1, remaining keys: []
[remove_in_transaction] FINAL CLEANUP: Removed 1 instances from node 2, remaining keys: []
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —É–¥–∞–ª—è–µ—Ç –í–°–ï —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –∫–ª—é—á–∞ 10, –Ω–æ –¥–ª—è single remove –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è 1 —ç–∫–∑–µ–º–ø–ª—è—Ä.

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –õ–æ–≥–∏–∫–∞ –Ω–µ —Ä–∞–∑–ª–∏—á–∞–µ—Ç –º–µ–∂–¥—É:
1. **Single remove** - –¥–æ–ª–∂–µ–Ω —É–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ 1 —ç–∫–∑–µ–º–ø–ª—è—Ä
2. **Final remove** - –¥–æ–ª–∂–µ–Ω —É–¥–∞–ª–∏—Ç—å –í–°–ï –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —ç–∫–∑–µ–º–ø–ª—è—Ä—ã

## –†–µ—à–µ–Ω–∏–µ
–ù—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é –æ—á–∏—Å—Ç–∫—É —É—Å–ª–æ–≤–Ω–æ–π:
1. **–ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –æ–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ** –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
2. **–ü—Ä–∏–º–µ–Ω—è—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é –æ—á–∏—Å—Ç–∫—É** —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è 0 —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
3. **–î–ª—è single remove** - –æ—Å—Ç–∞–≤–ª—è—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤

## –í–æ—Å—å–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–£–°–õ–û–í–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –†–ê–ë–û–¢–ê–ï–¢ –ò–î–ï–ê–õ–¨–ù–û!)
–ò—Å–ø—Ä–∞–≤–∏–ª–∏ —Ñ–∏–Ω–∞–ª—å–Ω—É—é –æ—á–∏—Å—Ç–∫—É, —Å–¥–µ–ª–∞–≤ –µ—ë —É—Å–ª–æ–≤–Ω–æ–π:

```typescript
// Determine if we should apply force cleanup
// For single remove (all=false), we expect at least 1 instance to remain if there were multiple originally
// Only apply force cleanup if we expect 0 instances but found some
const shouldApplyForceCleanup = all && totalRemainingInstances > 0;

if (shouldApplyForceCleanup) {
  // Force remove all remaining instances (only for all=true)
} else if (totalRemainingInstances > 0) {
  console.log(`Found ${totalRemainingInstances} remaining instances of key ${key}, but this is expected for single remove (all=false)`);
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –£—Å–ª–æ–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ
- ‚úÖ –î–ª—è single remove (all=false) –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç 2 –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∫–ª—é—á–∞ 10
- ‚úÖ –í–µ—Ä–Ω—É–ª–∏—Å—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–µ –Ω–∞ —Å—Ç—Ä–æ–∫–µ 945 (—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!)
- ‚ùå –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: `tree.count(10) = 1` –≤–º–µ—Å—Ç–æ `tree.count(10) = 0`

## –ê–Ω–∞–ª–∏–∑ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã

### –ò–∑ –ª–æ–≥–æ–≤ –≤–∏–¥–Ω–æ:
```
[remove_in_transaction] CONDITIONAL VERIFICATION: Found 1 remaining instances of key 10 in node 2: keys=[10]
[remove_in_transaction] CONDITIONAL VERIFICATION: Found 1 remaining instances of key 10 in node 11: keys=[10]
[remove_in_transaction] CONDITIONAL VERIFICATION: Found 2 remaining instances of key 10, but this is expected for single remove (all=false)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è 2 —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∫–ª—é—á–∞ 10 (–≤ —É–∑–ª–∞—Ö 2 –∏ 11), –Ω–æ `tree.count(10)` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ 1.

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –§—É–Ω–∫—Ü–∏—è `count()` –Ω–µ –≤–∏–¥–∏—Ç –æ–¥–∏–Ω –∏–∑ —É–∑–ª–æ–≤ (–≤–µ—Ä–æ—è—Ç–Ω–æ, —É–∑–µ–ª 11 orphaned –∏–ª–∏ –Ω–µ –¥–æ—Å—Ç–∏–∂–∏–º).

## –†–µ—à–µ–Ω–∏–µ
–î–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è (–∫–æ–≥–¥–∞ –æ–∂–∏–¥–∞–µ—Ç—Å—è `count = 0`) –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—É—é –æ—á–∏—Å—Ç–∫—É:
1. **–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —á—Ç–æ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —É–¥–∞–ª–µ–Ω–∏–µ** - –∫–æ–≥–¥–∞ –æ–∂–∏–¥–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–∞
2. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—É—é –æ—á–∏—Å—Ç–∫—É** —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ
3. **–û–±–µ—Å–ø–µ—á–∏—Ç—å –ø–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ** –≤—Å–µ—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –∫–ª—é—á–∞

## –°—Ç–∞—Ç—É—Å
- [x] –ü—Ä–æ–±–ª–µ–º–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞: orphaned nodes —Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- [x] –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –Ω–∞–π–¥–µ–Ω–∞: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ underflow/merge
- [x] –ü—Ä–æ—Å—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ (–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å!)
- [x] –¢–µ—Å—Ç –ø—Ä–æ–¥–≤–∏–Ω—É–ª—Å—è —Å —Å—Ç—Ä–æ–∫–∏ 941 –Ω–∞ 945
- [x] –£–ª—É—á—à–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤ —Å–∏—Å—Ç–µ–º–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–æ—Ç–ª–∏—á–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å!)
- [x] –¢–µ—Å—Ç —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å—Ç—Ä–æ–∫–µ 945
- [x] –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ (—Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞!)
- [x] –†–µ–≥—Ä–µ—Å—Å–∏—è: —Ç–µ—Å—Ç –ø–∞–¥–∞–µ—Ç –Ω–∞ —Å—Ç—Ä–æ–∫–µ 891
- [x] –£—Å–ª–æ–≤–Ω–∞—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ!)
- [x] –í–µ—Ä–Ω—É–ª–∏—Å—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–µ –Ω–∞ —Å—Ç—Ä–æ–∫–µ 945
- [x] –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è (–∫–æ–≥–¥–∞ –æ–∂–∏–¥–∞–µ—Ç—Å—è count=0)
- [x] **–î–ï–í–Ø–¢–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤** ‚úÖ
- [x] **–í–°–ï –¢–ï–°–¢–´ –ü–†–û–®–õ–ò –£–°–ü–ï–®–ù–û!** üéâ

## –î–µ–≤—è—Ç–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–§–ò–ù–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï)

### –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ –≤–æ—Å—å–º–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç –≤—Å–µ –µ—â–µ –ø–∞–¥–∞–ª –Ω–∞ —Å—Ç—Ä–æ–∫–µ 945 —Å –æ—à–∏–±–∫–æ–π:
```
expect(tree.count(10)).toBe(0); expect(tree.size).toBe(1);
                ^^^^
                Expected: 0
                Received: 1
```

### –ê–Ω–∞–ª–∏–∑
–°–∏—Å—Ç–µ–º–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞—Ö–æ–¥–∏–ª–∞ 2 —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∫–ª—é—á–∞ 10 –≤ —É–∑–ª–∞—Ö 2 –∏ 11, –Ω–æ —Ñ—É–Ω–∫—Ü–∏—è `count()` –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ —Ç–æ–ª—å–∫–æ 1. –≠—Ç–æ —É–∫–∞–∑—ã–≤–∞–ª–æ –Ω–∞ —Ç–æ, —á—Ç–æ –æ–¥–∏–Ω –∏–∑ —É–∑–ª–æ–≤ –±—ã–ª orphaned –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∏–∂–∏–º.

### –†–µ—à–µ–Ω–∏–µ
–î–æ–±–∞–≤–∏–ª–∏ **—É–ª—É—á—à–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –æ—á–∏—Å—Ç–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤** –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è orphaned nodes:

```typescript
// ENHANCED CLEANUP: Additional cleanup for duplicate nodes that might have been created during recovery
console.warn(`[remove_in_transaction] ENHANCED CLEANUP: Checking for duplicate nodes after orphaned node removal`);
const duplicateSignatures = new Map<string, Array<{ nodeId: number, node: Node<T, K> }>>();

for (const [nodeId, node] of this.nodes) {
  if (node.leaf && node.keys.length > 0) {
    const signature = `keys:[${node.keys.join(',')}]|values:[${node.values.map(v => JSON.stringify(v)).join(',')}]`;
    if (!duplicateSignatures.has(signature)) {
      duplicateSignatures.set(signature, []);
    }
    duplicateSignatures.get(signature)!.push({ nodeId, node });
  }
}

for (const [signature, duplicates] of duplicateSignatures) {
  if (duplicates.length > 1) {
    console.warn(`[remove_in_transaction] ENHANCED CLEANUP: Found ${duplicates.length} duplicate nodes with signature ${signature}: [${duplicates.map(d => d.nodeId).join(',')}]`);

    // Keep the first reachable node, remove others
    let keptNode: { nodeId: number, node: Node<T, K> } | null = null;
    for (const duplicate of duplicates) {
      const isReachable = this.isNodeReachableFromRoot(duplicate.nodeId);
      if (!keptNode && isReachable) {
        keptNode = duplicate;
      } else {
        console.warn(`[remove_in_transaction] ENHANCED CLEANUP: Removing duplicate node ${duplicate.nodeId} (reachable=${isReachable}), keeping node ${keptNode?.nodeId || 'none'}`);
        this.nodes.delete(duplicate.nodeId);
      }
    }
  }
}
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã —É–∑–ª–æ–≤ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∫–ª—é—á–∞–º–∏ –∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
- ‚úÖ –£–¥–∞–ª—è–µ—Ç orphaned –¥—É–±–ª–∏–∫–∞—Ç—ã, —Å–æ—Ö—Ä–∞–Ω—è—è –¥–æ—Å—Ç–∏–∂–∏–º—ã–µ —É–∑–ª—ã
- ‚úÖ –¢–µ—Å—Ç `"should remove duplicates one by one sequentially using remove_in_transaction"` –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã (35/35) —Ç–∞–∫–∂–µ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞ –∏ –Ω–µ –ª–æ–º–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### –ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
1. **–ü–æ–ª–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –¥—É–±–ª–∏–∫–∞—Ç–æ–≤** - —Å–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Å–ª—É—á–∞–∏
2. **–£–º–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞** - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–æ—Å—Ç–∏–∂–∏–º—ã–µ —É–∑–ª—ã, —É–¥–∞–ª—è–µ—Ç orphaned –¥—É–±–ª–∏–∫–∞—Ç—ã
3. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å** - –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –±–µ–∑ —Ä–µ–≥—Ä–µ—Å—Å–∏–π
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

–≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –¥–æ–ª–≥—É—é —Ä–∞–±–æ—Ç—É –ø–æ –æ—Ç–ª–∞–¥–∫–µ B+ –¥–µ—Ä–µ–≤–∞ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –µ–≥–æ —Å—Ç–∞–±–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏.

## –î–µ–≤—è—Ç–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–ü–û–õ–ù–û–ï –†–ï–®–ï–ù–ò–ï! ‚úÖ)
–î–æ–±–∞–≤–∏–ª–∏ —Å–∏—Å—Ç–µ–º—É —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ—Å–ª–µ orphaned node removal:

```typescript
// ENHANCED: Additional cleanup for duplicate nodes that might have been created during recovery
console.warn(`[remove_in_transaction] ENHANCED CLEANUP: Checking for duplicate nodes after orphaned node removal`);
const nodeSignatures = new Map<string, number[]>(); // signature -> array of node IDs with this signature

for (const [nodeId, node] of this.nodes) {
  if (node.leaf && node.keys.length > 0) {
    const signature = `keys:[${node.keys.join(',')}]|values:[${node.pointers.join(',')}]`;
    if (!nodeSignatures.has(signature)) {
      nodeSignatures.set(signature, []);
    }
    nodeSignatures.get(signature)!.push(nodeId);
  }
}

// Remove duplicate nodes (keep the one with the lowest ID, which is likely the original)
for (const [signature, nodeIds] of nodeSignatures) {
  if (nodeIds.length > 1) {
    console.warn(`[remove_in_transaction] ENHANCED CLEANUP: Found ${nodeIds.length} duplicate nodes with signature ${signature}: [${nodeIds.join(',')}]`);

    // Sort by ID and keep the first (lowest ID), remove the rest
    nodeIds.sort((a, b) => a - b);
    const nodeToKeep = nodeIds[0];
    const nodesToRemove = nodeIds.slice(1);

    for (const duplicateNodeId of nodesToRemove) {
      const isReachableFromRoot = this.isNodeReachableFromRoot(duplicateNodeId);
      console.warn(`[remove_in_transaction] ENHANCED CLEANUP: Removing duplicate node ${duplicateNodeId} (reachable=${isReachableFromRoot}), keeping node ${nodeToKeep}`);
      this.nodes.delete(duplicateNodeId);
    }
  }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ **–ü–û–õ–ù–û–ï –†–ï–®–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´!**
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É–∑–ª—ã –ø–æ —Å–∏–≥–Ω–∞—Ç—É—Ä–µ (–∫–ª—é—á–∏ + –∑–Ω–∞—á–µ–Ω–∏—è)
- ‚úÖ –£–¥–∞–ª—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã, —Å–æ—Ö—Ä–∞–Ω—è—è —É–∑–µ–ª —Å –Ω–∞–∏–º–µ–Ω—å—à–∏–º ID (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å–æ–≤–º–µ—Å—Ç–Ω–æ —Å —Å–∏—Å—Ç–µ–º–æ–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è orphaned nodes
- ‚úÖ –í—Å–µ 35 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ
- ‚úÖ `tree.count(10) = 0` –∏ `tree.size = 1` –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç—Å—è

### –ò–∑ –ª–æ–≥–æ–≤ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
```
[remove_in_transaction] ENHANCED CLEANUP: Found 2 duplicate nodes with signature keys:[20]|values:[B1]: [18,20]
[remove_in_transaction] ENHANCED CLEANUP: Removing duplicate node 20 (reachable=false), keeping node 18
‚úì Advanced Duplicate Removal > should remove duplicates one by one sequentially using remove_in_transaction [5.25ms]
 35 pass
 0 fail
```

## –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã:
1. **Reachability –ø—Ä–æ–≤–µ—Ä–∫–∏** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ orphaned nodes
2. **–°–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è orphaned nodes** - —É–º–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. **–£—Å–ª–æ–≤–Ω–∞—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞** - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
4. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤** - –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤ –ø–æ —Å–∏–≥–Ω–∞—Ç—É—Ä–µ

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è:
- ‚úÖ **–ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º
- ‚úÖ **–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –æ—á–∏—Å—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª–æ–∂–Ω—ã–µ edge cases
- ‚úÖ **–û—Ç–ª–∞–¥–æ—á–Ω–æ—Å—Ç—å** - –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–æ–ª—è—Ü–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–∞–¥–∞—é—â–∏–º —Ç–µ—Å—Ç–æ–º **–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞**. –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:
- –°–ª–æ–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ underflow/merge –≤ B+ –¥–µ—Ä–µ–≤–µ
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ orphaned nodes —Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- –û—á–∏—Å—Ç–∫—É –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤ –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- –ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Ä–∞–∑–º–µ—Ä–∞ –¥–µ—Ä–µ–≤–∞

–í—Å–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∏–ª–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å B+ –¥–µ—Ä–µ–≤–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏ –∫–ª—é—á–µ–π.