# –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–ø—ã—Ç–∞ B+ Tree –ø—Ä–æ–µ–∫—Ç–∞

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

- [–ü—Ä–∞–≤–∏–ª–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è](#-–ø—Ä–∞–≤–∏–ª–∞-–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
- [–ü—Ä–∞–≤–∏–ª–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#-–ø—Ä–∞–≤–∏–ª–∞-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
- [–ü—Ä–∞–≤–∏–ª–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è](#-–ø—Ä–∞–≤–∏–ª–∞-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
- [–ü—Ä–∞–≤–∏–ª–∞ –æ—Ç–ª–∞–¥–∫–∏](#-–ø—Ä–∞–≤–∏–ª–∞-–æ—Ç–ª–∞–¥–∫–∏)
- [–ü—Ä–∞–≤–∏–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è](#-–ø—Ä–∞–≤–∏–ª–∞-–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
- [–ü—Ä–∞–≤–∏–ª–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞](#-–ø—Ä–∞–≤–∏–ª–∞-—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞)

---

## üéØ –ü—Ä–∞–≤–∏–ª–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. **–§–∞–∑–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ**
```markdown
## Phase 1: Stabilize Core & Fix Bugs ‚úÖ
1. Fix critical memory/performance issues
2. Implement basic functionality with CoW
3. Fix parent-child relationship corruption
4. Implement commit() logic

## Phase 2: Complete Transaction Logic ‚úÖ
5. Implement transactional operations
6. Implement 2PC API
7. Add complex scenarios support

## Phase 3: Fix Advanced Operations ‚úÖ
8. Fix CoW Node Operations
9. Handle edge cases and boundary conditions
10. Implement conflict detection

## Phase 4: Refactor & Test ‚úÖ
11. Write comprehensive tests
12. Implement garbage collection
13. Performance optimization
```

### 2. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞**
```markdown
# Rules –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

- –¢–µ–∫—É—â–∏–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è –∏ –∏–¥–µ–∏ –∑–∞–ø–∏—Å—ã–≤–∞–π –≤ implementation —Ñ–∞–π–ª
- –£–¥–∞—á–Ω—ã–µ –∏–¥–µ–∏ –ø–æ–º–µ—á–∞–π ‚úÖ, –Ω–µ—É–¥–∞—á–Ω—ã–µ –∏–¥–µ–∏ –ø–æ–º–µ—á–∞–π ‚ùå
- –ò–¥–µ–∏ –Ω–µ —É–¥–∞–ª—è–π, —á—Ç–æ–±—ã –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∫ –Ω–∏–º –≤ –±—É–¥—É—â–∏—Ö —Å–µ—Å—Å–∏—è—Ö
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —ç—Ç–∞–ø–∞ —Ñ–∏–∫—Å–∏—Ä—É–π –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
```

### 3. **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º**
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –†–µ—à–∞–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø–µ—Ä–≤—ã–º–∏
enum ProblemPriority {
  CRITICAL = 'critical',    // –ë–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
  HIGH = 'high',           // –í–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  MEDIUM = 'medium',       // –£–ª—É—á—à–µ–Ω–∏—è UX
  LOW = 'low'             // Nice to have
}

// –ü—Ä–∏–º–µ—Ä –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞:
// CRITICAL: RangeError: Out of memory –≤ transactional remove
// HIGH: Parent-child relationship corruption –≤ CoW
// MEDIUM: –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ merge –æ–ø–µ—Ä–∞—Ü–∏–π
// LOW: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ utility —Ñ—É–Ω–∫—Ü–∏–∏
```

---

## üîß –ü—Ä–∞–≤–∏–ª–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Ç–µ—Å—Ç–æ–≤**
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –ª–æ–º–∞—é—Ç –¥—Ä—É–≥–∏–µ —Ç–µ—Å—Ç—ã
function validateTestDependencies() {
  // –ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–µ—Å—Ç–æ–≤ —É—á–∏—Ç—ã–≤–∞–π, —á—Ç–æ —Ç–µ—Å—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–≤–∏—Å–∏–º—ã–º–∏ –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞
  // –ß—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –æ–¥–∏–Ω —Ç–µ—Å—Ç, –Ω–µ –ª–æ–º–∞–π –¥—Ä—É–≥–æ–π
  // –°—Ç—Ä–æ–π –∫–∞—Ä—Ç—É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
}

// –ü—Ä–∏–º–µ—Ä –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞:
// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ merge —Ñ—É–Ω–∫—Ü–∏–π —Å–ª–æ–º–∞–ª–æ —Ç–µ—Å—Ç—ã borrow –æ–ø–µ—Ä–∞—Ü–∏–π
// –ü–æ—Ç—Ä–µ–±–æ–≤–∞–ª–æ—Å—å –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è separator keys
```

### 5. **–ò–∑–±–µ–≥–∞–Ω–∏–µ –∑–∞–≥–ª—É—à–µ–∫ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ**
```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –ó–∞–≥–ª—É—à–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –∫–æ–¥–µ
function merge_with_left_cow<T, K extends ValueType>(/* ... */) {
  // TODO: Implement real merge logic
  return originalNode // –ó–∞–≥–ª—É—à–∫–∞
}

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
function merge_with_left_cow<T, K extends ValueType>(/* ... */) {
  // –†–µ–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ merge —Å CoW
  const workingCopy = Node.forceCopy(originalNode, transactionContext)
  // ... –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
  return workingCopy
}

// –ü—Ä–∞–≤–∏–ª–æ: –ü—Ä–æ–≤–µ—Ä—è–π —á—Ç–æ —Ç–µ—Å—Ç—ã –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ –Ω–æ–≤—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º,
// –∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è
```

### 6. **Robust –ø–æ–∏—Å–∫ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è**
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: Robust –ø–æ–∏—Å–∫ —Å fallback
function findChildIndex<T, K extends ValueType>(
  parent: Node<T, K>,
  childOriginalId: number,
  txCtx: TransactionContext<T, K>
): number {
  // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ working copy ID
  const workingChild = txCtx.workingNodes.get(childOriginalId)
  if (workingChild) {
    const workingIndex = parent.pointers.indexOf(workingChild.id)
    if (workingIndex !== -1) return workingIndex
  }

  // Fallback: –∏—â–µ–º –ø–æ original ID
  const originalIndex = parent.pointers.indexOf(childOriginalId)
  if (originalIndex !== -1) return originalIndex

  throw new Error(`Child ${childOriginalId} not found in parent ${parent.id}`)
}

// –£—Ä–æ–∫ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞: –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –ø–æ ID —á–∞—Å—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ CoW —Å–∏—Å—Ç–µ–º–∞—Ö
```

### 7. **–ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–∞–º–∏**
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –§–ª–∞–≥–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏
function borrow_from_left_cow<T, K extends ValueType>(/* ... */) {
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  (fNode as any)._skipParentSeparatorUpdate = true
  (fLeftSibling as any)._skipParentSeparatorUpdate = true

  // –í—ã–ø–æ–ª–Ω—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é
  const result = performBorrow(/* ... */)

  // –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ separator keys
  updateParentSeparators(/* ... */)

  return result
}

// –£—Ä–æ–∫: –í —Å–ª–æ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö –Ω—É–∂–Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –º–µ–∂–¥—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –∏ —Ä—É—á–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
```

---

## üß™ –ü—Ä–∞–≤–∏–ª–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 8. **–í—ã—Å–æ–∫–æ–≥—Ä–∞–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã**
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –°–æ–∑–¥–∞–≤–∞–π –≤—ã—Å–æ–∫–æ–≥—Ä–∞–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –∏ –æ–±—ä–µ–¥–∏–Ω—è–π –∏—Ö –ø–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É
describe('Merge Operations', () => {
  describe('merge_with_left_cow', () => {
    it('should merge leaf nodes correctly', () => { /* ... */ })
    it('should update parent pointers', () => { /* ... */ })
    it('should handle separator keys', () => { /* ... */ })
    it('should work with working copies', () => { /* ... */ })
  })

  describe('merge_with_right_cow', () => {
    it('should merge internal nodes correctly', () => { /* ... */ })
    it('should preserve tree structure', () => { /* ... */ })
  })
})

// –ì—Ä—É–ø–ø–∏—Ä—É–π —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã, –Ω–æ —Ç–µ—Å—Ç–∏—Ä—É–π –∫–∞–∂–¥—ã–π –∞—Å–ø–µ–∫—Ç –æ—Ç–¥–µ–ª—å–Ω–æ
```

### 9. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ edge cases**
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ü–æ–∫—Ä—ã–≤–∞–π –≤—Å–µ –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏
describe('Edge Cases', () => {
  it('should handle empty nodes', () => {
    const emptyNode = Node.createLeaf(txCtx)
    expect(() => merge_with_left_cow(emptyNode, /* ... */)).not.toThrow()
  })

  it('should handle single element nodes', () => { /* ... */ })
  it('should handle maximum capacity nodes', () => { /* ... */ })
  it('should handle orphaned nodes', () => { /* ... */ })
  it('should handle duplicate keys', () => { /* ... */ })
})

// –£—Ä–æ–∫ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞: Edge cases —á–∞—Å—Ç–æ –≤—ã—è–≤–ª—è—é—Ç —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
```

### 10. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –í–∫–ª—é—á–∞–π —Ç–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
describe('Performance', () => {
  it('should handle large datasets efficiently', () => {
    const startTime = performance.now()

    // –í—ã–ø–æ–ª–Ω—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é
    for (let i = 0; i < 10000; i++) {
      tree.insert_in_transaction(i, `value${i}`, txCtx)
    }

    const duration = performance.now() - startTime
    expect(duration).toBeLessThan(1000) // –ú–µ–Ω–µ–µ 1 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è 10k –æ–ø–µ—Ä–∞—Ü–∏–π
  })
})

// –£—Ä–æ–∫: RangeError: Out of memory –±—ã–ª –æ–±–Ω–∞—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ —Ç–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
```

---

## üêõ –ü—Ä–∞–≤–∏–ª–∞ –æ—Ç–ª–∞–¥–∫–∏

### 11. **–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –ø–µ—Ä–µ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º**
```markdown
# –ü—Ä–∞–≤–∏–ª–æ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏

–ü–µ—Ä–µ–¥ –æ—Ç–ª–∞–¥–∫–æ–π –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤:
1. –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É –≤—Ä—É—á–Ω—É—é —Å –æ–∂–∏–¥–∞–µ–º—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
2. –ü–æ–º–µ—á–∞–π —à–∞–≥ –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞
3. –°–æ—Ö—Ä–∞–Ω—è–π —ç—Ç–æ—Ç –ª–æ–≥ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª markdown
4. –¢–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –æ—Ç–ª–∞–¥–∫–µ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

–ü—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–æ–≤ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞:
- failed.2pc.isolation.md
- failed.duplicate.keys.md
- failed.transaction.abort.md
```

### 12. **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
function remove_in_transaction<T, K extends ValueType>(
  tree: BPlusTree<T, K>,
  key: K,
  txCtx: TransactionContext<T, K>
): boolean {
  console.log(`[REMOVE_TX] Starting removal of key ${key}`)

  const leaf = find_leaf_for_key_in_transaction(tree, key, txCtx)
  console.log(`[REMOVE_TX] Found leaf ${leaf.id} with ${leaf.keys.length} keys`)

  const keyIndex = find_first_key(leaf.keys, key, tree.comparator)
  console.log(`[REMOVE_TX] Key index: ${keyIndex}`)

  if (keyIndex === -1 || tree.comparator(leaf.keys[keyIndex], key) !== 0) {
    console.log(`[REMOVE_TX] Key ${key} not found`)
    return false
  }

  // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
}
```

### 13. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤**
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ
function validateTreeInvariants<T, K extends ValueType>(
  tree: BPlusTree<T, K>,
  operation: string
): void {
  console.log(`[VALIDATION] Checking invariants after ${operation}`)

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–µ—Ä–µ–≤–∞
  const structureValid = validateTreeStructure(tree)
  if (!structureValid) {
    throw new Error(`Tree structure invalid after ${operation}`)
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º parent-child —Å–≤—è–∑–∏
  const linksValid = validateParentChildLinks(tree)
  if (!linksValid) {
    throw new Error(`Parent-child links invalid after ${operation}`)
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –∫–ª—é—á–µ–π
  const orderValid = validateKeyOrder(tree)
  if (!orderValid) {
    throw new Error(`Key order invalid after ${operation}`)
  }

  console.log(`[VALIDATION] All invariants valid after ${operation}`)
}
```

---

## üìö –ü—Ä–∞–≤–∏–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 14. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏–π**
```markdown
# –ü—Ä–∞–≤–∏–ª–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ—à–µ–Ω–∏–π

–î–ª—è –∫–∞–∂–¥–æ–π —Ä–µ—à–µ–Ω–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π:

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #N: –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
- **–†–µ—à–µ–Ω–∏–µ:** –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ
- **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –ö–æ–¥/–∞–ª–≥–æ—Ä–∏—Ç–º
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
- **–§–∞–π–ª—ã:** –ö–∞–∫–∏–µ —Ñ–∞–π–ª—ã –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã

–ü—Ä–∏–º–µ—Ä –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞:
## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #1: 2PC Transaction Isolation
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ù–∞—Ä—É—à–µ–Ω–∏–µ snapshot isolation –≤ prepare —Ñ–∞–∑–µ
- **–†–µ—à–µ–Ω–∏–µ:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —É–∑–ª–æ–≤
- **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
  ```typescript
  this._snapshotNodeStates = new Map();
  for (const [nodeId, node] of tree.nodes) {
    this._snapshotNodeStates.set(nodeId, { ... });
  }
  ```
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –¢–µ—Å—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é
- **–§–∞–π–ª—ã:** `src/TransactionContext.ts`, `src/BPlusTree.ts`
```

### 15. **–í–µ–¥–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏**
```markdown
# –ü—Ä–∞–≤–∏–ª–æ –≤–µ–¥–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

–û—Ç—Å–ª–µ–∂–∏–≤–∞–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω–æ:

**–ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –£–°–ü–ï–•–ê:**
- **‚úÖ –í–°–ï 340 –¢–ï–°–¢–û–í –ü–†–û–•–û–î–Ø–¢** (100% success rate)
- **‚úÖ insert_in_transaction:** –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- **‚úÖ remove_in_transaction:** –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- **‚úÖ 2PC API:** –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- **‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è:** –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **‚úÖ Copy-on-Write:** –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç

–≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤–∏–¥–µ—Ç—å –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
```

### 16. **–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –°–æ–∑–¥–∞–≤–∞–π —Ä–∞–±–æ—á–∏–µ –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
// examples/transaction-example.ts
async function transactionExample() {
  const tree = new BPlusTree<User, number>(3, false)
  const txCtx = new TransactionContext(tree)

  // –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
  tree.insert_in_transaction(1, { name: 'Alice' }, txCtx)
  tree.insert_in_transaction(2, { name: 'Bob' }, txCtx)

  // –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ–º 2PC
  const canCommit = await txCtx.prepareCommit()
  if (canCommit) {
    await txCtx.finalizeCommit()
  }

  console.log('Transaction completed successfully')
}

// –ü—Ä–∏–º–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏ –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
```

---

## üîÑ –ü—Ä–∞–≤–∏–ª–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

### 17. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥**
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ø–æ –æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞ —Ä–∞–∑
// –®–∞–≥ 1: –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
function merge_with_left_cow_v2<T, K extends ValueType>(/* ... */) {
  // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
}

// –®–∞–≥ 2: –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é
describe('merge_with_left_cow_v2', () => {
  // –í—Å–µ —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
})

// –®–∞–≥ 3: –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
// –®–∞–≥ 4: –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ–º –≤—Å–µ —Å—Ä–∞–∑—É
```

### 18. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏**
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π API –ø—Ä–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ
// –°—Ç–∞—Ä—ã–π API (deprecated)
function insert(key: K, value: T): boolean {
  console.warn('insert() is deprecated, use insert_in_transaction()')
  const txCtx = new TransactionContext(this)
  const result = this.insert_in_transaction(key, value, txCtx)
  txCtx.commit()
  return result
}

// –ù–æ–≤—ã–π API
function insert_in_transaction(key: K, value: T, txCtx: TransactionContext<T, K>): boolean {
  // –ù–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
}
```

### 19. **–ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞**
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –û—Ç—Å–ª–µ–∂–∏–≤–∞–π –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
interface CodeQualityMetrics {
  testCoverage: number        // 100% –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
  cyclomaticComplexity: number // < 10 –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Ñ—É–Ω–∫—Ü–∏–π
  linesOfCode: number         // –û—Ç—Å–ª–µ–∂–∏–≤–∞–π —Ä–æ—Å—Ç
  technicalDebt: number       // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ TODO/FIXME
  performanceRegression: boolean // –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
}

// –ü—Ä–∏–º–µ—Ä –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞:
// –ë—ã–ª–æ: 13 –ø—Ä–æ–≤–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤, —Å–ª–æ–∂–Ω–æ—Å—Ç—å > 15
// –°—Ç–∞–ª–æ: 0 –ø—Ä–æ–≤–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤, —Å–ª–æ–∂–Ω–æ—Å—Ç—å < 8
```

---

## üìã –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ PR

### –ü–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º:
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (–≤–∫–ª—é—á–∞—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ)
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- [ ] –ù–µ—Ç memory leaks
- [ ] –ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∏–ª—é –ø—Ä–æ–µ–∫—Ç–∞

### –ü–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º:
- [ ] –í—Å–µ —Ñ–∞–∑—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã
- [ ] 100% —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
- [ ] –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞
- [ ] –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ —Ö—É–∂–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
- [ ] –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ —É—Ä–æ–∫–∏ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞

### 1. **–°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–∞—Å—Ç–µ—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ**
- –ü—Ä–æ—Å—Ç—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–≥—É—Ç —Å–ª–æ–º–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤
- –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
- –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–∞–∑–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å—é

### 2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - —ç—Ç–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è**
- –í—ã—Å–æ–∫–æ–≥—Ä–∞–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø–æ–º–æ–≥–∞—é—Ç –±—ã—Å—Ç—Ä–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
- Edge cases —á–∞—Å—Ç–æ –≤—ã—è–≤–ª—è—é—Ç —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- –¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 3. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–∫–æ–Ω–æ–º–∏—Ç –≤—Ä–µ–º—è**
- –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –ø–æ–º–æ–≥–∞—é—Ç –≤ –æ—Ç–ª–∞–¥–∫–µ
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏–π –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏
- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤—ã—è–≤–ª—è—é—Ç –ø—Ä–æ–±–ª–µ–º—ã UX

### 4. **–ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–∞–º–∏ –∫—Ä–∏—Ç–∏—á–Ω–∞**
- –í —Å–ª–æ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö –Ω—É–∂–Ω—ã –º–µ—Ö–∞–Ω–∏–∑–º—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏
- –§–ª–∞–≥–∏, —Å–æ–±—ã—Ç–∏—è, callbacks –ø–æ–º–æ–≥–∞—é—Ç –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- –í—Å–µ–≥–¥–∞ –¥—É–º–∞–π –æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### 5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–∞ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞**
- Memory leaks –º–æ–≥—É—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É
- –ê–ª–≥–æ—Ä–∏—Ç–º–∏—á–µ—Å–∫–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ –º–∏–∫—Ä–æ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
- –†–µ–≥—É–ª—è—Ä–Ω–æ –∏–∑–º–µ—Ä—è–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

---

*–ü—Ä–∞–≤–∏–ª–∞ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –æ–ø—ã—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ B+ Tree —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π*
*–ü—Ä–æ–µ–∫—Ç: 340 —Ç–µ—Å—Ç–æ–≤, 100% success rate, –ø–æ–ª–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞*
*–í–µ—Ä—Å–∏—è: 1.0 | –î–∞—Ç–∞: –î–µ–∫–∞–±—Ä—å 2024*