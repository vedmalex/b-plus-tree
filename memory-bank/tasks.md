# План устранения технического долга в `b-pl-tree` (Уровень 4)

## 1. Анализ требований

Устранить критический технический долг в библиотеке `b-pl-tree`, который блокирует разработку в `collection-store`. Основные требования:
*   Исправить некорректное удаление записей из неуникальных индексов.
*   Реализовать или починить range-запросы (поиск по диапазону: `<`, `>`, `<=`, `>=`).
*   Реализовать безопасные транзакционные операции "чтение-изменение-запись" (ACID).

## 2. Затрагиваемые компоненты

*   **Основной компонент:** `b-pl-tree` (весь пакет).
*   **Зависимый компонент:** `collection-store` (особенно `IndexManager` и `QueryEngine`).
*   **Среда:** `bun` (проблемы со сборкой и кэшированием).

## 3. Архитектурные соображения

*   **Изолированная разработка:** Работа будет вестись непосредственно в пакете `b-pl-tree`.
*   **Совместимость API:** Сохранение текущего API для обратной совместимости с `collection-store`.
*   **Транзакционная модель:** Использование Copy-on-Write (CoW) для обеспечения ACID.

## 4. Фазы реализации

### Фаза 1: Валидация среды (✅ Завершено)
*   ✅ Настройка изолированной среды разработки.
*   ✅ Проверка текущей функциональности с использованием существующих тестов.
*   ✅ Выявление основных проблемных участков кода.

### Фаза 2: Неуникальные индексы (⏳ В процессе)
*   ✅ Анализ текущего поведения при удалении неуникальных индексов.
*   ⏳ Создание дополнительных тестов для проверки удаления неуникальных индексов.
*   ⏳ Исправление алгоритма удаления для неуникальных индексов.
*   ⏳ Тестирование исправленного алгоритма.

### Фаза 3: Range-запросы (✅ Завершено)
*   ✅ Анализ текущей реализации range-запросов.
*   ✅ Реализация метода `range()` с использованием подхода Find-and-Scan.
*   ✅ Создание тестов для проверки поиска по диапазону.
*   ✅ Оптимизация производительности range-запросов.

### Фаза 4: Транзакции (⏳ В процессе)
*   ✅ Анализ текущей реализации транзакций в `b-pl-tree`.
*   ✅ Улучшение глубокого копирования в методах Node.serialize и Node.deserialize.
*   ✅ Модификация метода Node.forceCopy для более надежной изоляции.
*   ✅ Рефакторинг метода find_all_in_transaction для улучшения изоляции.
*   ⏳ Исправление проблем с методом remove_in_transaction.
*   ⏳ Тестирование изоляции транзакций.

## 5. Тестирование и интеграция

*   ⏳ Создание комплексных тестов для всех исправленных компонентов.
*   ⏳ Интеграционное тестирование с `collection-store`.
*   ⏳ Мониторинг производительности для выявления узких мест.

## 6. Документация и завершение

*   ⏳ Обновление документации API.
*   ⏳ Подготовка примеров использования для новых функций.
*   ⏳ Создание релиза пакета `b-pl-tree`.

## Текущий статус

*   **Фаза 1 (Валидация среды)**: ✅ Завершено
*   **Фаза 2 (Неуникальные индексы)**: ⏳ В процессе (~30% выполнено)
*   **Фаза 3 (Range-запросы)**: ✅ Завершено (100% выполнено)
*   **Фаза 4 (Транзакции)**: ⏳ В процессе (~70% выполнено)
*   **Общий прогресс**: ⏳ В процессе (~50% выполнено)
